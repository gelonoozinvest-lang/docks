Техническое задание: Wazuh — Мониторинг безопасности и SIEM

---

1. Цель

Внедрить Wazuh как централизованную платформу для сбора, анализа и корреляции событий безопасности (SIEM) в рамках всей бизнес-фабрики. Wazuh должен обеспечивать мониторинг в реальном времени, обнаружение угроз, аудит соответствия и автоматическое оповещение.

---

2. Архитектура и место в фабрике

Wazuh является ядром слоя `Monitoring & Security Layer`, как указано в `Security white paper.md`.

`
graph TD
    subgraph "Источники логов"
        A[Cloudflare: WAF/AI-WAF]
        B[IAM Service]
        C[Router AI Agents]
        D[RAG Service]
        E[Vault]
        F[Хосты (VM/Серверы)]
    end

    subgraph "Слой мониторинга"
        Wazuh((Wazuh Server))
    end

    subgraph "Получатели оповещений"
        T[Telegram-канал Security]
        H[Factory Health Aggregator]
        DASH[Wazuh Dashboard]
    end

    A -->|Logs via API/Syslog| Wazuh
    B -->|Logs| Wazuh
    C -->|Logs| Wazuh
    D -->|Logs| Wazuh
    E -->|Audit Logs| Wazuh
    F -->|Wazuh Agent| Wazuh

    Wazuh -->|Alerts| T
    Wazuh -->|Security Data| H
    Wazuh -->|Visualization| DASH
`

---

3. Источники логов и собираемые данные

Wazuh агрегирует логи из следующих источников:

3.1. **Cloudflare (WAF & AI-WAF)**
- **Данные**: Заблокированные запросы, попытки инъекций (SQL, XSS, Prompt Injection), события Rate-Limiting, аномалии трафика.
- **Интеграция**: Через Cloudflare Logpush или API.
- **Документ**: `AI Request Firewall (AI‑WAF).md`.

3.2. **Identity & Access Layer (IAM)**
- **Данные**: Успешные и неудачные входы, запросы на JIT-доступ, смена ролей, ошибки аутентификации.
- **Интеграция**: Прямая отправка логов из Supabase/сервиса IAM.
- **Документ**: `Identity & Access Layer (IAM).md`.

3.3. **Хосты (Серверы и ВМ)**
- **Данные**: Системные события, доступ к файлам (FIM), запуск процессов, сетевые подключения, уязвимости (Vulnerability Detection).
- **Интеграция**: Через нативный агент Wazuh.

3.4. **HashiCorp Vault**
- **Данные**: Аудит-логи: распечатывание (unseal), аутентификация, чтение/запись секретов, изменение политик.
- **Интеграция**: Через audit log-файл, который читает агент Wazuh.
- **Документ**: `Vault Namespace Specification .md`.

3.5. **Внутренние сервисы (Router, RAG, n8n)**
- **Данные**: Критические ошибки, ошибки доступа, аномальное поведение агентов.
- **Интеграция**: Отправка логов по Syslog или в файл, отслеживаемый агентом.

---

4. Ключевые сценарии мониторинга и оповещения

Wazuh настраивается для обнаружения следующих угроз:

| Сценарий | Пример правила | Уровень риска | Получатель |
|---|---|---|---|
| **Множественные ошибки входа** | 5+ неудачных попыток входа для одного пользователя за 1 минуту | **Высокий** | Telegram |
| **Попытка SQL/XSS/Prompt инъекции** | Обнаружен паттерн инъекции в логах AI-WAF | **Критический** | Telegram |
| **Изменение критичного файла** | Изменён файл `terraform.tfstate` или `/etc/passwd` (FIM) | **Высокий** | Telegram |
| **Распечатывание Vault** | Событие "unseal" в аудит-логе Vault | **Критический** | Telegram |
| **Повышение привилегий в IAM** | Пользователю назначена роль `factory_admin` | **Средний** | Лог в Health |
| **Обнаружена уязвимость** | На хосте найдена уязвимость с CVSS > 7.0 | **Высокий** | Telegram |
| **Аномальный трафик** | Нетипично большое количество запросов с одного IP | **Средний** | Лог в Health |

---

5. Интеграция с другими сервисами

5.1. **Factory Health Aggregator**
- Wazuh передает агрегированные данные о состоянии безопасности (количество критических алертов, уровень угроз) в `Factory Health Aggregator Service.md`.

5.2. **Security Whitepaper**
- Данный документ является практической реализацией политик, описанных в `Security white paper.md`.

---

6. Результат

- **Централизованная видимость**: Все события безопасности собраны в одном месте.
- **Быстрое реагирование**: Автоматические оповещения позволяют немедленно реагировать на угрозы.
- **Глубокий анализ**: Возможность ретроспективного анализа инцидентов.
- **Соответствие требованиям**: Наличие SIEM-системы является требованием многих стандартов (ISO 27001, SOC 2).
