# Развертывание Zitadel Cloud (Free Tier)

## 1. Цель

Этот документ описывает пошаговый процесс развертывания и базовой настройки Zitadel Cloud (Free Tier) для использования в качестве центрального Identity Provider (IdP) для всех сервисов бизнес-фабрики. Zitadel будет обеспечивать аутентификацию (SSO, MFA) и выдачу JWT-токенов, которые затем будут использоваться `Identity & Access Layer (IAM).md` для авторизации.

## 2. Предпосылки

Перед началом развертывания убедитесь, что у вас есть:

- Активный аккаунт Cloudflare (рекомендуется для управления DNS и проксирования).
- Доменное имя, которое будет использоваться для Zitadel (например, `auth.your-factory.com`).
- Базовое понимание концепций OAuth2/OIDC.

## 3. Шаги развертывания

### 3.1. Регистрация в Zitadel Cloud

1.  Перейдите на сайт [Zitadel Cloud](https://zitadel.com/cloud).
2.  Нажмите "Start for Free" или "Sign Up".
3.  Пройдите процесс регистрации, используя ваш email или аккаунт GitHub/Google.
4.  После регистрации вы будете перенаправлены в консоль управления Zitadel.

### 3.2. Настройка организации и проекта

1.  **Создание организации**: При первой регистрации Zitadel предложит создать вашу первую организацию. Дайте ей осмысленное имя (например, `YourFactory`).
2.  **Создание проекта**: Внутри организации создайте новый проект (например, `Business Factory Services`). Этот проект будет содержать все ваши приложения (OIDC Clients).

### 3.3. Создание приложения (OIDC Client)

Для каждого сервиса, который будет использовать Zitadel для аутентификации (например, `IAM Service`, `Router AI Agents`, `RAG Service`), вам нужно создать OIDC-приложение.

1.  В консоли Zitadel перейдите в ваш проект (`Business Factory Services`).
2.  Нажмите "Add Application".
3.  Выберите тип приложения: "Web Application" (для бэкенд-сервисов, которые будут валидировать токены) или "User Agent (SPA)" (для фронтенд-приложений). Для наших бэкенд-сервисов обычно подходит "Web Application" или "Machine".
4.  **Настройте приложение**:
    *   **Name**: Дайте приложению имя (например, `RAG Service API`).
    *   **Redirect URIs**: Это критически важный параметр. Укажите URL, на который Zitadel будет перенаправлять пользователя после успешной аутентификации. Для API-сервисов это может быть URL вашего Swagger UI (`http://localhost:8000/oauth2-redirect.html` для локальной разработки) или URL, который будет использоваться для получения токенов.
    *   **Post Logout Redirect URIs**: URL, куда перенаправлять после выхода.
    *   **Grant Types**: Выберите `Authorization Code` (для веб-приложений) и `Refresh Token` (для долгоживущих сессий).
    *   **Response Types**: `Code`.
    *   **Token Endpoint Auth Method**: `Client Secret Post` или `Client Secret Basic`.
5.  После создания приложения Zitadel предоставит вам **Client ID** и **Client Secret**. Сохраните их в безопасном месте (например, в Vault).

### 3.4. Настройка пользователей и ролей

1.  **Создание пользователей**: В разделе "Users" вашей организации вы можете создавать пользователей, которые будут иметь доступ к фабрике.
2.  **Назначение ролей**: В Zitadel вы можете определять роли и назначать их пользователям. Эти роли могут быть переданы в JWT-токене и использованы `Identity & Access Layer (IAM).md` для детальной авторизации.

### 3.5. Получение Client ID и Client Secret

После создания OIDC-приложения, Zitadel отобразит `Client ID` и `Client Secret`. Эти данные необходимы вашим сервисам для взаимодействия с Zitadel (например, для обмена кодом авторизации на JWT-токен).

**Важно**: `Client Secret` является конфиденциальной информацией и должен храниться в HashiCorp Vault, как описано в `Vault Namespace Specification .md`.

## 4. Интеграция с фабрикой

-   **IAM Service**: `Identity & Access Layer (IAM).md` будет основным потребителем Zitadel. Он будет валидировать JWT-токены, выданные Zitadel, и использовать информацию из них для принятия решений об авторизации.
-   **Другие сервисы**: `Router AI Agents`, `RAG Service` и другие сервисы будут принимать JWT-токены от клиентов и передавать их в `IAM Service` для проверки прав доступа.

## 5. Соображения безопасности

-   **Client Secret**: Никогда не храните `Client Secret` в коде или открытом виде. Используйте Vault.
-   **Redirect URIs**: Всегда указывайте максимально точные `Redirect URIs`, чтобы предотвратить атаки перенаправления.
-   **Scopes**: Запрашивайте только те OIDC-скоупы, которые действительно необходимы вашему приложению.
-   **Zitadel Console Access**: Ограничьте доступ к консоли Zitadel только для авторизованных администраторов.

## 6. Связанные документы

-   `Identity & Access Layer (IAM).md`: Детальная спецификация слоя управления идентификацией и доступом.
-   `Security white paper.md`: Общий обзор стратегии безопасности фабрики.
-   `Vault Namespace Specification .md`: Стандарт хранения секретов, включая Client Secret для Zitadel.
